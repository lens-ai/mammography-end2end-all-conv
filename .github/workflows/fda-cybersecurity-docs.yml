name: ğŸ¥ Generate FDA Cybersecurity Documentation

on:
  workflow_dispatch:
    inputs:
      output_format:
        description: 'ğŸ“„ Documentation Format'
        required: true
        default: 'full'
        type: choice
        options:
          - full      # All 11 required FDA documents
          - quick     # 6 essential documents only

jobs:
  generate-fda-docs:
    name: ğŸ¥ Generate FDA Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸš€ Generate FDA Documentation
      env:
        BASETEN_API_KEY: ${{ secrets.BASETEN_API_KEY }}
        DEVICE_NAME: 'Mammography Cancer Detection'   # âš ï¸ CUSTOMIZE THIS
        DEVICE_MANUFACTURER: 'HealthTech Inc'              # âš ï¸ CUSTOMIZE THIS
        DEVICE_VERSION: ${{ github.ref_name || '1.0.0' }}
      run: |
        echo "ğŸ¥ Generating FDA documentation for: ${{ github.repository }}"
        echo "ğŸ“‹ Device: ${DEVICE_NAME} v${DEVICE_VERSION}"
        echo "ğŸ­ Manufacturer: ${DEVICE_MANUFACTURER}"
        
        # Create output directory
        mkdir -p ./fda-output
        
        # Force pull latest image (bypass cache)
        echo "ğŸ“¥ Pulling latest FDA generator Docker image..."
        docker pull --no-cache lensai/lensai-fda-cybersecurity:latest
        
        # Verify image architecture
        echo "ğŸ” Verifying image architecture..."
        docker image inspect lensai/lensai-fda-cybersecurity:latest --format '{{.Architecture}}' || echo "Could not get architecture"
        
        # Run the FDA documentation generator
        echo "ğŸš€ Running FDA documentation generator..."
        docker run --rm \
          -e BASETEN_API_KEY="${BASETEN_API_KEY}" \
          -e BASETEN_MODEL="deepseek-ai/DeepSeek-R1" \
          -e GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}" \
          -e GITHUB_REPO="${{ github.repository }}" \
          -e DEVICE_NAME="${DEVICE_NAME}" \
          -e DEVICE_VERSION="${DEVICE_VERSION}" \
          -e DEVICE_MANUFACTURER="${DEVICE_MANUFACTURER}" \
          -v $(pwd)/fda-output:/output \
          lensai/lensai-fda-cybersecurity:latest \
          --mode ${{ github.event.inputs.output_format || 'full' }} \
          --output-dir /output
        
        # List generated documents
        echo ""
        echo "ğŸ“„ Generated FDA Documents:"
        ls -la ./fda-output/ || echo "Check if documents were generated"
        
    - name: ğŸ“¦ Upload FDA Documentation
      uses: actions/upload-artifact@v4
      with:
        name: fda-cybersecurity-docs-${{ github.run_id }}
        path: ./fda-output/
        retention-days: 90
        if-no-files-found: warn
        
    - name: ğŸ‰ Success Message
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         âœ… FDA DOCUMENTATION GENERATED!           â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘  Repository: ${{ github.repository }}"
        echo "â•‘  Device: ${DEVICE_NAME}"
        echo "â•‘  Download: Actions â†’ Artifacts"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“¥ To download your FDA documents:"
        echo "1. Go to the Actions tab"
        echo "2. Click on this workflow run"
        echo "3. Download 'fda-cybersecurity-docs-${{ github.run_id }}'"
        echo ""
        echo "ğŸ“‹ Generated documents include:"
        echo "âœ… Enhanced SBOM with vulnerability analysis"
        echo "âœ… Architecture and security design"
        echo "âœ… Threat model (STRIDE analysis)"
        echo "âœ… Risk assessment and mitigation"
        echo "âœ… Security controls (FDA's 8 categories)"
        echo "âœ… Validation report and evidence"
        echo "âœ… Incident response procedures"
        echo "âœ… Vulnerability management"
        echo "âœ… Penetration test results"
        echo "âœ… Security update procedures"
        echo "âœ… Traceability matrix"%
