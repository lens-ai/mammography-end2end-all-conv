# ðŸ¥ FDA Cybersecurity Documentation Generator - Client Workflow
# Copy this file to .github/workflows/fda-docs.yml in your repository
# Then add required secrets to your repository settings

name: ðŸ¥ Generate FDA Documentation

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'Your Medical Device Name'
        required: true
        default: 'My Medical Device'
      device_manufacturer:
        description: 'Your Company Name'
        required: true
        default: 'My Company'
      device_version:
        description: 'Software Version'
        required: false
        default: '1.0.0'
      output_format:
        description: 'Documentation Scope'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - incremental

jobs:
  generate-fda-docs:
    name: ðŸ¥ Generate FDA Documents
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‹ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ“¦ Pull FDA Generator and Tools
      run: |
        echo "ðŸ“¦ Pulling FDA Generator container from Docker Hub..."
        docker pull lensai/lensai-fda-cybersecurity:latest
        
        echo "ðŸ“¦ Pulling SBOM generation tools..."
        docker pull anchore/syft:latest
        docker pull anchore/grype:latest
        
        echo "âœ… All containers ready!"

    - name: ðŸ¥ Generate FDA Documentation
      run: |
        echo "ðŸš€ Starting FDA documentation generation..."
        echo "ðŸ“Š Analyzing repository: ${{ github.repository }}"
        echo "ðŸ¥ Device: ${{ github.event.inputs.device_name }} v${{ github.event.inputs.device_version }}"
        
        # Create output directory
        mkdir -p ./fda-output
        
        # Note: Using pre-built container from Docker Hub
        # Make sure lensai/lensai-fda-cybersecurity:latest is up to date
        # Container includes MCP Direct Docker client for spawning MCP containers
        
        # Record start time
        START_TIME=$(date +%s)
        
        # Run FDA documentation generator with MCP Docker spawn mode
        # The container will spawn MCP containers internally if available
        docker run --rm \
          -e BASETEN_API_KEY="${{ secrets.BASETEN_API_KEY }}" \
          -e BASETEN_MODEL="deepseek-ai/DeepSeek-R1" \
          -e GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}" \
          -e GITHUB_REPO="${{ github.repository }}" \
          -e DEVICE_NAME="${{ github.event.inputs.device_name }}" \
          -e DEVICE_VERSION="${{ github.event.inputs.device_version }}" \
          -e DEVICE_MANUFACTURER="${{ github.event.inputs.device_manufacturer }}" \
          -e JIRA_URL="${{ secrets.JIRA_URL }}" \
          -e JIRA_EMAIL="${{ secrets.JIRA_EMAIL }}" \
          -e JIRA_API_TOKEN="${{ secrets.JIRA_API_TOKEN }}" \
          -e JIRA_PROJECT_KEY="${{ secrets.JIRA_PROJECT_KEY }}" \
          -e CONFLUENCE_URL="${{ secrets.CONFLUENCE_URL }}" \
          -e CONFLUENCE_EMAIL="${{ secrets.CONFLUENCE_EMAIL }}" \
          -e CONFLUENCE_API_TOKEN="${{ secrets.CONFLUENCE_API_TOKEN }}" \
          -e CONFLUENCE_SPACE_KEY="${{ secrets.CONFLUENCE_SPACE_KEY }}" \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v ${{ github.workspace }}:/repo:ro \
          -v ${{ github.workspace }}/fda-output:/output \
          lensai/lensai-fda-cybersecurity:latest \
          python -m src.main --mode ${{ github.event.inputs.output_format }} --output-dir /output
        
        # Calculate generation time
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        # Count generated documents
        DOC_COUNT=$(find ./fda-output -name "*.md" -type f | wc -l)
        
        # Calculate success rate
        if [ "${{ github.event.inputs.output_format }}" = "full" ]; then
          TOTAL_DOCS=11
        else
          TOTAL_DOCS=6  # Essential documents only
        fi
        SUCCESS_RATE=$(( (DOC_COUNT * 100) / TOTAL_DOCS ))
        
        echo "ðŸ“Š GENERATION RESULTS:"
        echo "   Documents Generated: $DOC_COUNT/$TOTAL_DOCS ($SUCCESS_RATE%)"
        echo "   Generation Time: ${DURATION}s"
        echo "   Output Directory: ./fda-output/"
        
        echo "ðŸ“„ Generated FDA Documents:"
        find ./fda-output -name "*.md" -type f -exec basename {} \; | sort
    
    - name: ðŸ“Š Upload FDA Documents
      uses: actions/upload-artifact@v4
      with:
        name: fda-cybersecurity-docs-${{ github.run_id }}
        path: ./fda-output/
        retention-days: 30
        if-no-files-found: error
    
    - name: ðŸ“‹ Summary
      run: |
        echo "## ðŸ¥ FDA Documentation Generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Success!" >> $GITHUB_STEP_SUMMARY
        echo "- **Device**: ${{ github.event.inputs.device_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Manufacturer**: ${{ github.event.inputs.device_manufacturer }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ github.event.inputs.device_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Format**: ${{ github.event.inputs.output_format }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Documents**: $(find ./fda-output -name "*.md" -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“„ Generated Files:" >> $GITHUB_STEP_SUMMARY
        find ./fda-output -name "*.md" -type f -exec basename {} \; | sort | sed 's/^/- âœ… /' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download the artifacts above to get your FDA cybersecurity documentation!" >> $GITHUB_STEP_SUMMARY%
